# ================== CONFIG ==================
CC      = gcc
FLEX    = flex
BISON   = bison
TARGET  = compiler.exe
INPUT   = valid.txt

# Windows Short Paths to bypass the "Program Files (x86)" space error
BISON_DATA = C:/PROGRA~2/GnuWin32/share/bison
M4_PATH    = C:/PROGRA~2/GnuWin32/bin/m4.exe

# ================== TARGETS ==================

# Running 'make' will build and then run the test automatically
all: $(TARGET) test

$(TARGET): lex.yy.c parser.tab.c
	@echo [INFO] Compiling C files...
	$(CC) lex.yy.c parser.tab.c -o $(TARGET)
	@echo [OK] Build successful.

lex.yy.c: lexer.l parser.tab.h
	@echo [INFO] Running Flex...
	$(FLEX) lexer.l

parser.tab.c parser.tab.h: parser.y
	@echo [INFO] Running Bison with environment fix...
	@cmd /c "set BISON_PKGDATADIR=$(BISON_DATA)&& set M4=$(M4_PATH)&& $(BISON) -d parser.y"

# PowerShell-friendly test execution
test: $(TARGET)
	@echo [INFO] Testing with $(INPUT)...
	@powershell -Command "Get-Content $(INPUT) | .\$(TARGET)"

clean:
	@echo [INFO] Cleaning files...
	@powershell -Command "Remove-Item -Force lex.yy.c, parser.tab.c, parser.tab.h, $(TARGET) -ErrorAction SilentlyContinue"